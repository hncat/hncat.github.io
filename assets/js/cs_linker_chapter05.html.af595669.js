"use strict";(self.webpackChunkfar_blog=self.webpackChunkfar_blog||[]).push([[267],{6262:(i,s)=>{s.A=(i,s)=>{const a=i.__vccOpts||i;for(const[i,n]of s)a[i]=n;return a}},3798:(i,s,a)=>{a.r(s),a.d(s,{comp:()=>k,data:()=>t});var n=a(641);const l=[(0,n.Fv)('<h2 id="_1-什么是动态链接" tabindex="-1"><a class="header-anchor" href="#_1-什么是动态链接"><span>1. 什么是动态链接</span></a></h2><div class="hint-container important"><p class="hint-container-title">重要</p><p>把链接的过程推迟到运行时进行，这就是动态链接(Dynamic Linking)的基本思想。<br> 需要注意的是，程序与动态库之间真正的链接工作是由动态链接器完成的，而不静态链接器ld完成。</p></div><h2 id="_2-简单的动态链接例子" tabindex="-1"><a class="header-anchor" href="#_2-简单的动态链接例子"><span>2. 简单的动态链接例子</span></a></h2><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">// Program1.c</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;Lib.h&quot;</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">() {</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  foobar</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">  return</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">// Program2.c</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;Lib.h&quot;</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">() {</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  foobar</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">  return</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">// Lib.c</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &lt;stdio.h&gt;</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> foobar</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> i</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) {</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  printf</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;Printing from Lib.so </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">%d</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, i);</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">// Lib.h</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">#ifndef</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> __LIB_H__</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> __LIB_H__</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> foobar</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> i</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">#endif</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用GCC将Lib.c编译成一个共享对象文件:</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># shared 表示产生共享对象</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># -fPIC 表示生成位置无关代码</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">gcc</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -fPIC</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -shared</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Lib.so</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Lib.c</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 分别编译链接Program1和Program2</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">gcc</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Program1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Program1.c</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ./Lib.so</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">gcc</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Program2</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Program2.c</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ./Lib.so</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="/image/linker/chapter05/动态链接过程.png" alt="动态链接过程" tabindex="0" loading="lazy"><figcaption>动态链接过程</figcaption></figure><div class="hint-container important"><p class="hint-container-title">重要</p><p>Lib.c被链接成Lib.so共享对象文件，Program1.c被编译成Program1.o之后，链接成为可指向文件Program1。但是和静态链接不同的是，Program1.o被链接成可执行文件这一步。在静态链接中，链接过程会把Program1.o和Lib.o链接到一起，并且输出可执行文件Program1。但是对于动态链接，Lib.o没有被链接起来，链接的输入目标只有Program1.o。但是命令行中又发现Lib.so也参与了链接过程？<br> 当程序模块Program1.c被编译成Program1.o时，编译器还不知道foobar()函数的地址。当链接器将Program1.o链接成可执行文件时，这时候链接器必须确定foobar()函数的性质。如果foobar()函数是一个定义于<mark>静态目标模块</mark>中的函数，那么链接器将会按照静态链接的规则，<mark>将Program1.o中的foobar()地址引用重定位</mark>。如果foobar()是一个定义在<mark>动态共享对象</mark>中的函数，那么链接器就会将这个符号的引用标记为一个动态链接的符号，<mark>不对其进行地址重定位，把这个过程保留到装载时进行</mark>。<br> 对于链接器是如何知道foobar()函数的引用是一个静态符号还是动态符号？这其实就是我们要用到Lib.so的原因。<mark>Lib.so保留了完整的符号信息（因为运行时进行动态链接还需要使用符号信息）</mark>，把Lib.so也作为链接的输入文件之一，<mark>链接器在解析符号时就可以知道：foobar()函数是一个定义在Lib.so的动态符号</mark>。这样链接器就可以堆foobar()函数的引用进行特殊处理，使它成为一个对动态符号的引用。</p></div><p><strong>动态链接程序运行时地址空间分布</strong></p><div class="hint-container note"><p class="hint-container-title">注</p><p>对于静态链接的可执行文件，整个进程只有可执行文件需要被映射。但是对于动态链接来说，除了可执行文件之外，还有它所依赖的共享目标文件。</p></div><p>对Lib.c的foobar()函数进行修改</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">// Lib.c</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &lt;stdio.h&gt;</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &lt;unistd.h&gt;</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> foobar</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> i</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) {</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  printf</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;Printing from Lib.so </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">%d</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, i);</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  sleep</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">./Program1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> &amp;</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[1] </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">10370</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Printing</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Lib.so</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">cat</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /proc/10370/maps</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">5611c3c79000-5611c3c7a000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> r--p</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 00000000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 08:10</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 117001</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">                     /home/far/worker/linker/chapter04/SimpleDynamicalLinking/Program1</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">5611c3c7a000-5611c3c7b000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> r-xp</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 00001000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 08:10</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 117001</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">                     /home/far/worker/linker/chapter04/SimpleDynamicalLinking/Program1</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">5611c3c7b000-5611c3c7c000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> r--p</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 00002000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 08:10</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 117001</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">                     /home/far/worker/linker/chapter04/SimpleDynamicalLinking/Program1</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">5611c3c7c000-5611c3c7d000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> r--p</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 00002000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 08:10</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 117001</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">                     /home/far/worker/linker/chapter04/SimpleDynamicalLinking/Program1</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">5611c3c7d000-5611c3c7e000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> rw-p</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 00003000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 08:10</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 117001</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">                     /home/far/worker/linker/chapter04/SimpleDynamicalLinking/Program1</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">5611c5450000-5611c5471000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> rw-p</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 00000000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 00:00</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">                          [heap]</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">7f066eb09000-7f066eb0c000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> rw-p</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 00000000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 00:00</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">7f066eb0c000-7f066eb34000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> r--p</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 00000000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 08:10</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 49449</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">                      /usr/lib/x86_64-linux-gnu/libc.so.6</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">7f066eb34000-7f066ecbc000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> r-xp</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 00028000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 08:10</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 49449</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">                      /usr/lib/x86_64-linux-gnu/libc.so.6</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">7f066ecbc000-7f066ed0b000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> r--p</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 001b0000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 08:10</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 49449</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">                      /usr/lib/x86_64-linux-gnu/libc.so.6</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">7f066ed0b000-7f066ed0f000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> r--p</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 001fe000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 08:10</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 49449</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">                      /usr/lib/x86_64-linux-gnu/libc.so.6</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">7f066ed0f000-7f066ed11000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> rw-p</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 00202000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 08:10</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 49449</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">                      /usr/lib/x86_64-linux-gnu/libc.so.6</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">7f066ed11000-7f066ed1e000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> rw-p</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 00000000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 00:00</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">7f066ed25000-7f066ed26000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> r--p</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 00000000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 08:10</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 116994</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">                     /home/far/worker/linker/chapter04/SimpleDynamicalLinking/Lib.so</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">7f066ed26000-7f066ed27000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> r-xp</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 00001000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 08:10</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 116994</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">                     /home/far/worker/linker/chapter04/SimpleDynamicalLinking/Lib.so</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">7f066ed27000-7f066ed28000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> r--p</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 00002000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 08:10</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 116994</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">                     /home/far/worker/linker/chapter04/SimpleDynamicalLinking/Lib.so</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">7f066ed28000-7f066ed29000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> r--p</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 00002000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 08:10</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 116994</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">                     /home/far/worker/linker/chapter04/SimpleDynamicalLinking/Lib.so</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">7f066ed29000-7f066ed2a000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> rw-p</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 00003000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 08:10</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 116994</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">                     /home/far/worker/linker/chapter04/SimpleDynamicalLinking/Lib.so</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">7f066ed2a000-7f066ed2c000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> rw-p</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 00000000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 00:00</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">7f066ed2c000-7f066ed2d000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> r--p</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 00000000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 08:10</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 49446</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">                      /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">7f066ed2d000-7f066ed58000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> r-xp</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 00001000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 08:10</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 49446</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">                      /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">7f066ed58000-7f066ed62000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> r--p</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 0002c000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 08:10</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 49446</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">                      /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">7f066ed62000-7f066ed64000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> r--p</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 00036000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 08:10</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 49446</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">                      /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">7f066ed64000-7f066ed66000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> rw-p</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 00038000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 08:10</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 49446</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">                      /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">7ffe6cfa3000-7ffe6cfc4000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> rw-p</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 00000000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 00:00</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">                          [stack]</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">7ffe6cfe6000-7ffe6cfea000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> r--p</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 00000000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 00:00</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">                          [vvar]</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">7ffe6cfea000-7ffe6cfeb000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> r-xp</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 00000000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 00:00</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">                          [vdso]</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">kill</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 10370</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[1]  + 10370 terminated  ./Program1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>观察到整个虚拟地址空间中，多出了几个文件的映射。Lib.so与Program1一样，它们都是被操作系统用同样的方法映射至进程的虚拟地址空间。Program1除了使用Lib.so外，还是用到了动态链接形式的<mark>C语言运行时库(/usr/lib/x86_64-linux-gnu/libc.so.6)</mark>。还有Linux下的<mark>动态链接器(/usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2)</mark>。动态链接器和普通共享对象一样被映射到进程的地址空间，在系统开始运行Program1之前，首先将控制权交给动态链接器，由它完成所有的动态链接工作后再把控制权交给Program1，最后开始执行。</p><p>通过readelf查看Lib.so的装载属性:</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">readelf</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -l</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Lib.so</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Elf</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> file</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> type</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> is</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> DYN</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (Shared </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">object</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> file</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Entry</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> point</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0x0</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">There</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> are</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 11</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> program</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> headers,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> starting</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> at</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> offset</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 64</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Program</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Headers:</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Type</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">           Offset</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">             VirtAddr</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">           PhysAddr</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">                 FileSiz</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">            MemSiz</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">              Flags</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  Align</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  LOAD</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">           0x0000000000000000</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0x0000000000000000</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0x0000000000000000</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">                 0x0000000000000560</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0x0000000000000560</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  R</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">      0x1000</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  LOAD</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">           0x0000000000001000</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0x0000000000001000</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0x0000000000001000</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">                 0x000000000000017d</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0x000000000000017d</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  R</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> E</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">    0x1000</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  LOAD</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">           0x0000000000002000</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0x0000000000002000</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0x0000000000002000</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">                 0x00000000000000dc</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0x00000000000000dc</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  R</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">      0x1000</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  LOAD</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">           0x0000000000002df8</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0x0000000000003df8</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0x0000000000003df8</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">                 0x0000000000000220</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0x0000000000000228</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  RW</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">     0x1000</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  DYNAMIC</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">        0x0000000000002e08</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0x0000000000003e08</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0x0000000000003e08</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">                 0x00000000000001c0</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0x00000000000001c0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  RW</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">     0x8</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  NOTE</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">           0x00000000000002a8</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0x00000000000002a8</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0x00000000000002a8</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">                 0x0000000000000020</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0x0000000000000020</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  R</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">      0x8</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  NOTE</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">           0x00000000000002c8</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0x00000000000002c8</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0x00000000000002c8</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">                 0x0000000000000024</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0x0000000000000024</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  R</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">      0x4</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  GNU_PROPERTY</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">   0x00000000000002a8</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0x00000000000002a8</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0x00000000000002a8</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">                 0x0000000000000020</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0x0000000000000020</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  R</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">      0x8</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  GNU_EH_FRAME</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">   0x000000000000201c</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0x000000000000201c</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0x000000000000201c</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">                 0x000000000000002c</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0x000000000000002c</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  R</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">      0x4</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  GNU_STACK</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">      0x0000000000000000</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0x0000000000000000</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0x0000000000000000</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">                 0x0000000000000000</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0x0000000000000000</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  RW</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">     0x10</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  GNU_RELRO</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">      0x0000000000002df8</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0x0000000000003df8</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0x0000000000003df8</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">                 0x0000000000000208</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0x0000000000000208</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  R</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">      0x1</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> Section</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Segment</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> mapping:</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Segment</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Sections...</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">   00</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">     .note.gnu.property</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> .note.gnu.build-id</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> .gnu.hash</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> .dynsym</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> .dynstr</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> .gnu.version</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> .gnu.version_r</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> .rela.dyn</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> .rela.plt</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">   01</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">     .init</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> .plt</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> .plt.got</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> .plt.sec</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> .text</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> .fini</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">   02</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">     .rodata</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> .eh_frame_hdr</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> .eh_frame</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">   03</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">     .init_array</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> .fini_array</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> .dynamic</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> .got</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> .got.plt</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> .data</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> .bss</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">   04</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">     .dynamic</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">   05</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">     .note.gnu.property</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">   06</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">     .note.gnu.build-id</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">   07</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">     .note.gnu.property</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">   08</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">     .eh_frame_hdr</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">   09</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">   10</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">     .init_array</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> .fini_array</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> .dynamic</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> .got</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container note"><p class="hint-container-title">注</p><p>除了文件类型与普通程序不同之外，其它几乎与普通程序一样。还有一点不同的是，动态链接模块的装载地址是从地址0x0000000000000000开始的。我们知道这个地址是无效地址，并且从上面的进程虚拟空间分布看到，Lib.so的最终装载地址并不是0x0000000000000000，而是0x7f066ed25000。从这一点可以推断，<mark>共享对象的最终装载地址在编译时是不确定的</mark>，而是在装载时，装载器根据当前地址空间的空闲情况，动态的分配一块足够大小的地址空间给相应的共享对象。</p></div><h2 id="_3-地址无关代码" tabindex="-1"><a class="header-anchor" href="#_3-地址无关代码"><span>3. 地址无关代码</span></a></h2><h3 id="_3-1-固定装载地址的困扰" tabindex="-1"><a class="header-anchor" href="#_3-1-固定装载地址的困扰"><span>3.1 固定装载地址的困扰</span></a></h3><div class="hint-container note"><p class="hint-container-title">注</p><p>为了实现动态链接，我们首先会遇到的问题是共享对象地址冲突问题。在动态链接的情况下，如果不同的模块目标装载地址都一样是不行的。而对于单个程序来说，我们可以手工指定各个模块的地址，比如0x1000到0x2000分配给模块A，把地址0x2000到0x3000分配给模块B。但是，如果某个模块被多个程序使用，或者多个模块被多个程序使用呢？这将会使得管理这些模块的地址将是一件无比繁琐的事情。<br> 例如程序program1使用了模块B，但是没有使用模块A，所以他认为地址0x1000到0x2000的地址是空闲的，余数分配给了另一个模块C。这样C和原先的模块A的目标地址就冲突了，任何人以后将不能在同一个程序里面使用模块A和C。这种做法就叫做<mark>静态共享库(Static Shared Library)</mark>。相比于静态链接，静态共享库的做法就是将程序的各个模块统一交给操作系统管理，操作系统在某个特定的地址划分出一些地址块，为那些已知的模块预留足够的空间。<br> 静态共享库的目标地址导致了很多问题，除了地址冲突外，静态共享库的升级也是问题，因为升级后的共享库必须保持共享库中全局函数和变量地址的不变，如果应用程序在链接时已经绑定了这些地址，一旦变更，就必须重新链接应用程序，否则就会引起应用程序崩溃。即使升级静态共享库后保持原有的函数和变量地址不变，只是增加了一些全局函数或变量，也会受到限制，因为静态共享库被分配到的虚拟地址空间是有限的，不能增长太多，否则就会超出被分配的空间。<br> 为了解决这个模块装载地址固定的问题，我们设想是否可以让共享对象在<mark>任意地址</mark>加载？既<mark>共享对象在编译时不能假设自己在进程虚拟地址空间中的位置</mark>。对于可执行文件基本可以确定自己在进程虚拟空间中的起始位置，因为可执行文件往往是第一个被加载的文件。</p></div><h3 id="_3-2-装载时重定位" tabindex="-1"><a class="header-anchor" href="#_3-2-装载时重定位"><span>3.2 装载时重定位</span></a></h3><div class="hint-container important"><p class="hint-container-title">重要</p><p>在链接时，对所有绝对地址的引用不做重定位，而把这一步推迟到装载时完成。一旦模块装载地址确定，既目标地址确定，那么系统就对程序中所有的绝对地址引用进行重定位。<br> 静态链接时的重定位被称为<mark>链接时重定位(Link Time Relocation)</mark>，而现在这种情况通常被称为<mark>装载时重定位(Load Time Relocation)</mark>。<br> 装载时重定位的问题：动态链接模块被装载至虚拟空间后，指令部分是在多个进程之间共享的，由于装载时重定位的方法需要修改指令，所以没有办法做到同一份指令被多个进程共享，<mark>因为指令部分对于每个进程来说可能会被映射到每个进程的不同虚拟空间，从而导致这些地址对每个进程来说是不同的</mark>。而对于可修改数据部分来说每个进程都有不同的副本，所以可以使用装载时重定位的方法来处理。<br> Linux的GCC编译器支持这种装载时重定位的方法，在编译时可以只使用-shared选项而不使用-fPIC选项。</p></div><h3 id="_3-3-地址无关代码" tabindex="-1"><a class="header-anchor" href="#_3-3-地址无关代码"><span>3.3 地址无关代码</span></a></h3><div class="hint-container note"><p class="hint-container-title">注</p><p>装载时重定位是解决动态模块中没有绝对地址应用的办法之一，但是有一个很大的缺点是指令部分无法在多个进程之间共享，这样就失去了动态链接节省内存的一大优势。<br> 现在我们希望程序模块中共享的指令部分在装载时不需要因为装载地址的改变而改变，所以我们只需要将指令中那些需要被修改的部分进行剥离，和数据部分放在一起，这样指令部分就可以保持不变，而数据部分可以在每个进程中拥有一个副本。这种方案就是<mark>地址无关代码(PIC, Position-independent Code)</mark>。</p></div><p>将共享对象中的地址引用按照是否跨模块分为: <mark>模块内部引用和模块外部引用</mark>。</p><p>按照不同的引用方式又分为：<mark>指令引用和数据访问</mark>。</p><p>因此有如下方式:</p><ul><li>模块内部的函数调用、跳转等。</li><li>模块内部的数据访问，比如模块中定义的全局变量、静态变量。</li><li>模块外部的函数调用、跳转等。</li><li>模块外部的数据访问，比如其它模块中定义的全局变量。</li></ul><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> a;</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">extern</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> b;</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">extern</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> ext</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> bar</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">() {</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  a </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> // 模块内部数据访问</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  b</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">  // 模块外部数据访问</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> foo</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">() {</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  bar</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> // 模块内部函数调用</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  ext</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> // 模块外部函数调用</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-asm line-numbers-mode" data-highlighter="shiki" data-ext="asm" data-title="asm" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">// bar为非静态函数时</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">0000000000001139</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> &lt;bar&gt;:</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">    1139</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:       f3 0f 1e fa             </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">endbr64</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">    113d</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:       c7 </span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">05</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> ed 2e </span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">00</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 00</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 01</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    movl   </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$0x1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0x2eed</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">rip</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)       </span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> # 4034 &lt;a&gt;</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">    1144</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:       </span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">00</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 00</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 00</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">    1147</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:       </span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">48</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> 8b </span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">05</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> 8a 2e </span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">00</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 00</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    mov</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">    0x2e8a</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">rip</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">),%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">rax</span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">        # 3fd8 &lt;b&gt;</span></span>\n<span class="line"><span style="--shiki-light:#B31D28;--shiki-dark:#FFFFFF;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">    114e:</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">       c7 </span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">00</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 02</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 00</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 00</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 00</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">       movl   </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$0x2</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,(%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">rax</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">    1154</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:       c3                      </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">ret</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">0000000000001155</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> &lt;foo&gt;:</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">    1155</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:       f3 0f 1e fa             </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">endbr64</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">    1159</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:       </span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">48</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 83</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> ec </span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">08</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">             sub</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">    $0x8</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">rsp</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">    115d</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:       b8 </span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">00</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 00</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 00</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 00</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">          mov</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">    $0x0</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">eax</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">    1162</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:       e8 </span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">09</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> ff ff ff          </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">call</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">   1070</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> &lt;bar@plt&gt;</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">    1167</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:       b8 </span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">00</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 00</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 00</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 00</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">          mov</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">    $0x0</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">eax</span></span>\n<span class="line"><span style="--shiki-light:#B31D28;--shiki-dark:#FFFFFF;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">    116c:</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">       e8 ef fe ff ff          </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">call</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">   1060</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> &lt;ext@plt&gt;</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">    1171</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:       </span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">48</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 83</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> c4 </span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">08</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">             add</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">    $0x8</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">rsp</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">    1175</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:       c3                      </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">ret</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> a;</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">extern</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> b;</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">extern</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> ext</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> bar</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">() {</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  a </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> // 模块内部数据访问</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  b</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">  // 模块外部数据访问</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> foo</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">() {</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  bar</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> // 模块内部函数调用</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  ext</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> // 模块外部函数调用</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-asm line-numbers-mode" data-highlighter="shiki" data-ext="asm" data-title="asm" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">// bar非静态函数时</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">0000000000001119</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> &lt;bar&gt;:</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">    1119</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:       c7 </span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">05</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 09</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> 2f </span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">00</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 00</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 01</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    movl   </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$0x1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0x2f09</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">rip</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)       </span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> # 402c &lt;a&gt;</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">    1120</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:       </span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">00</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 00</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 00</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">    1123</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:       </span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">48</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> 8b </span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">05</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> ae 2e </span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">00</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 00</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    mov</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">    0x2eae</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">rip</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">),%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">rax</span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">        # 3fd8 &lt;b&gt;</span></span>\n<span class="line"><span style="--shiki-light:#B31D28;--shiki-dark:#FFFFFF;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">    112a:</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">       c7 </span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">00</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 02</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 00</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 00</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 00</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">       movl   </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$0x2</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,(%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">rax</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">    1130</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:       c3                      </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">ret</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">0000000000001131</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> &lt;foo&gt;:</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">    1131</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:       f3 0f 1e fa             </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">endbr64</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">    1135</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:       </span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">48</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 83</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> ec </span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">08</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">             sub</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">    $0x8</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">rsp</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">    1139</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:       b8 </span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">00</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 00</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 00</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 00</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">          mov</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">    $0x0</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">eax</span></span>\n<span class="line"><span style="--shiki-light:#B31D28;--shiki-dark:#FFFFFF;--shiki-light-font-style:italic;--shiki-dark-font-style:inherit;">    113e:</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">       e8 d6 ff ff ff          </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">call</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">   1119</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> &lt;bar&gt;</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">    1143</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:       b8 </span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">00</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 00</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 00</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 00</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">          mov</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">    $0x0</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">eax</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">    1148</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:       e8 </span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">03</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> ff ff ff          </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">call</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">   1050</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> &lt;ext@plt&gt;</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">    114d</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:       </span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">48</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 83</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> c4 </span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">08</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">             add</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">    $0x8</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">rsp</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">    1151</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:       c3                      </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">ret</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>类型一 模块内部调用或跳转</strong></p><div class="hint-container note"><p class="hint-container-title">注</p><p>根据objdump反汇编后得到的结果和书中列出的不太一样。实际汇编得到的结果是使用了<mark>共享对象全局符号介入(Global Symbol Interposition)</mark>。在动态链接的实现中会提到。<br> 但是当你讲bar函数修改为静态成员函数时就是书中想要的结果(或许是书中的纰漏吧，作为补充我在这里给出了书中想要的效果)。</p></div><p>这种情况是最简单的，因为被调用的函数与调用者都在同一个模块，所以它们之间的相对位置是固定的，所以这种情况会比较简单。对于现代系统来说，模块内部的跳转、函数调用都可以是相对地址调用，或者是基于寄存器的相对调用，所以对于这种指令是不需要重定位的。</p><p><strong>类型二 模块内部数据访问</strong><br> 任何一条指令与它需要访问的模块内部数据之间的相对位置是固定的，那么只需要相对于当前指令(PC值)加上固定的偏移量就可以访问模块内部数据了。例如函数bar中的一段反汇编代码:</p><div class="language-asm line-numbers-mode" data-highlighter="shiki" data-ext="asm" data-title="asm" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># %rip既是对应的PC值(当前执行的下一条指令)</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">113d</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:       c7 </span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">05</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> ed 2e </span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">00</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 00</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 01</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    movl   </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$0x1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">0x2eed</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">rip</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)       </span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> # 4034 &lt;a&gt;</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">1144</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:       </span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">00</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 00</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 00</span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> # a内存地址进行了一次内存对齐，所以需要补0所以%rip实际值为0x1144</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">1147</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:       </span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">48</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> 8b </span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">05</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> 8a 2e </span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;">00</span><span style="--shiki-light:#005CC5;--shiki-dark:#C678DD;"> 00</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    mov</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">    0x2e8a</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">rip</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">),%</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">rax</span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">        # 3fd8 &lt;b&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>假设该模块经过加载后位于虚拟内存的0x10000000处，那变量a所在的虚拟内存地址为: 0x2eed + 0x1147 + 0x10000000 = 0x10004034。<br> 而通过查看符号表信息可以得到变量a所在elf文件中的位置:</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">readelf</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -s</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> libpic.so</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 只显示了部分数据</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">...</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">ymbol</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> table</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;.symtab&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> contains</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 29</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> entries:</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">   Num:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    Value</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">          Size</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Type</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    Bind</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   Vis</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      Ndx</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Name</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">    ...</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    10:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0000000000004034</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">     4</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> OBJECT</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  LOCAL</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  DEFAULT</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">   22</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> a</span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> # 0x1147 + 0x2eed = 0x4034</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">    ...</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>类型三 模块间数据访问</strong><br> 要使得代码地址无关，基本的思想是把和地址相关的部分放到数据段里面，很明显，这些其它模块的全局变量的地址是和模块装载地址相关的。elf的做法是在数据段里面创建一个<mark>指向这些变量的指针数组</mark>，也被称为<mark>全局偏移表(Global Offset Table, GOT)</mark>，当代码需要引用该变量时，可以通过GOT中相对应的项间接引用。如图:</p><figure><img src="/image/linker/chapter05/模块间数据访问.png" alt="模块间数据访问" tabindex="0" loading="lazy"><figcaption>模块间数据访问</figcaption></figure><h2 id="_4-延迟般的-plt" tabindex="-1"><a class="header-anchor" href="#_4-延迟般的-plt"><span>4. 延迟般的(PLT)</span></a></h2><h2 id="_5-动态链接相关结构" tabindex="-1"><a class="header-anchor" href="#_5-动态链接相关结构"><span>5. 动态链接相关结构</span></a></h2><h2 id="_6-动态链接的步骤和实现" tabindex="-1"><a class="header-anchor" href="#_6-动态链接的步骤和实现"><span>6. 动态链接的步骤和实现</span></a></h2><h2 id="_7-显示运行时链接" tabindex="-1"><a class="header-anchor" href="#_7-显示运行时链接"><span>7. 显示运行时链接</span></a></h2>',45)],h={},k=(0,a(6262).A)(h,[["render",function(i,s){return(0,n.uX)(),(0,n.CE)("div",null,l)}]]),t=JSON.parse('{"path":"/cs/linker/chapter05.html","title":"第五章 动态链接","lang":"zh-CN","frontmatter":{"title":"第五章 动态链接","date":"2024-07-08T00:00:00.000Z","tags":["计算机基础","c/c++"],"categories":"链接、装载与库","isOriginal":true,"order":5,"dir":{"order":5},"description":"1. 什么是动态链接 重要 把链接的过程推迟到运行时进行，这就是动态链接(Dynamic Linking)的基本思想。 需要注意的是，程序与动态库之间真正的链接工作是由动态链接器完成的，而不静态链接器ld完成。 2. 简单的动态链接例子 使用GCC将Lib.c编译成一个共享对象文件: 动态链接过程动态链接过程 重要 Lib.c被链接成Lib.so共享对...","head":[["meta",{"property":"og:url","content":"https://hncat.github.io/cs/linker/chapter05.html"}],["meta",{"property":"og:site_name","content":"far"}],["meta",{"property":"og:title","content":"第五章 动态链接"}],["meta",{"property":"og:description","content":"1. 什么是动态链接 重要 把链接的过程推迟到运行时进行，这就是动态链接(Dynamic Linking)的基本思想。 需要注意的是，程序与动态库之间真正的链接工作是由动态链接器完成的，而不静态链接器ld完成。 2. 简单的动态链接例子 使用GCC将Lib.c编译成一个共享对象文件: 动态链接过程动态链接过程 重要 Lib.c被链接成Lib.so共享对..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://hncat.github.io/image/linker/chapter05/动态链接过程.png"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-07-11T12:28:12.000Z"}],["meta",{"property":"article:author","content":"Mr.far"}],["meta",{"property":"article:tag","content":"计算机基础"}],["meta",{"property":"article:tag","content":"c/c++"}],["meta",{"property":"article:published_time","content":"2024-07-08T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2024-07-11T12:28:12.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"第五章 动态链接\\",\\"image\\":[\\"https://hncat.github.io/image/linker/chapter05/动态链接过程.png\\",\\"https://hncat.github.io/image/linker/chapter05/模块间数据访问.png\\"],\\"datePublished\\":\\"2024-07-08T00:00:00.000Z\\",\\"dateModified\\":\\"2024-07-11T12:28:12.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Mr.far\\",\\"url\\":\\"https://hncat.github.io\\"}]}"]]},"headers":[{"level":2,"title":"1. 什么是动态链接","slug":"_1-什么是动态链接","link":"#_1-什么是动态链接","children":[]},{"level":2,"title":"2. 简单的动态链接例子","slug":"_2-简单的动态链接例子","link":"#_2-简单的动态链接例子","children":[]},{"level":2,"title":"3. 地址无关代码","slug":"_3-地址无关代码","link":"#_3-地址无关代码","children":[{"level":3,"title":"3.1 固定装载地址的困扰","slug":"_3-1-固定装载地址的困扰","link":"#_3-1-固定装载地址的困扰","children":[]},{"level":3,"title":"3.2 装载时重定位","slug":"_3-2-装载时重定位","link":"#_3-2-装载时重定位","children":[]},{"level":3,"title":"3.3 地址无关代码","slug":"_3-3-地址无关代码","link":"#_3-3-地址无关代码","children":[]}]},{"level":2,"title":"4. 延迟般的(PLT)","slug":"_4-延迟般的-plt","link":"#_4-延迟般的-plt","children":[]},{"level":2,"title":"5. 动态链接相关结构","slug":"_5-动态链接相关结构","link":"#_5-动态链接相关结构","children":[]},{"level":2,"title":"6. 动态链接的步骤和实现","slug":"_6-动态链接的步骤和实现","link":"#_6-动态链接的步骤和实现","children":[]},{"level":2,"title":"7. 显示运行时链接","slug":"_7-显示运行时链接","link":"#_7-显示运行时链接","children":[]}],"git":{"createdTime":1720572885000,"updatedTime":1720700892000,"contributors":[{"name":"far","email":"v19991123v@163.com","commits":9}]},"readingTime":{"minutes":13.35,"words":4005},"filePathRelative":"cs/linker/chapter05.md","localizedDate":"2024年7月8日","excerpt":"<h2>1. 什么是动态链接</h2>\\n<div class=\\"hint-container important\\">\\n<p class=\\"hint-container-title\\">重要</p>\\n<p>把链接的过程推迟到运行时进行，这就是动态链接(Dynamic Linking)的基本思想。<br>\\n需要注意的是，程序与动态库之间真正的链接工作是由动态链接器完成的，而不静态链接器ld完成。</p>\\n</div>\\n<h2>2. 简单的动态链接例子</h2>\\n<div class=\\"language-c line-numbers-mode\\" data-highlighter=\\"shiki\\" data-ext=\\"c\\" data-title=\\"c\\" style=\\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\\"><pre class=\\"shiki shiki-themes github-light one-dark-pro vp-code\\"><code><span class=\\"line\\"><span style=\\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\\">// Program1.c</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#D73A49;--shiki-dark:#C678DD\\">#include</span><span style=\\"--shiki-light:#032F62;--shiki-dark:#98C379\\"> \\"Lib.h\\"</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#D73A49;--shiki-dark:#C678DD\\">int</span><span style=\\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\\"> main</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\\">() {</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\\">  foobar</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\\">(</span><span style=\\"--shiki-light:#005CC5;--shiki-dark:#D19A66\\">1</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\\">);</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#D73A49;--shiki-dark:#C678DD\\">  return</span><span style=\\"--shiki-light:#005CC5;--shiki-dark:#D19A66\\"> 0</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\\">;</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\\">}</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\\">// Program2.c</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#D73A49;--shiki-dark:#C678DD\\">#include</span><span style=\\"--shiki-light:#032F62;--shiki-dark:#98C379\\"> \\"Lib.h\\"</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#D73A49;--shiki-dark:#C678DD\\">int</span><span style=\\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\\"> main</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\\">() {</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\\">  foobar</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\\">(</span><span style=\\"--shiki-light:#005CC5;--shiki-dark:#D19A66\\">2</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\\">);</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#D73A49;--shiki-dark:#C678DD\\">  return</span><span style=\\"--shiki-light:#005CC5;--shiki-dark:#D19A66\\"> 0</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\\">;</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\\">}</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\\">// Lib.c</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#D73A49;--shiki-dark:#C678DD\\">#include</span><span style=\\"--shiki-light:#032F62;--shiki-dark:#98C379\\"> &lt;stdio.h&gt;</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#D73A49;--shiki-dark:#C678DD\\">void</span><span style=\\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\\"> foobar</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\\">(</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#C678DD\\">int</span><span style=\\"--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\\"> i</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\\">) {</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\\">  printf</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\\">(</span><span style=\\"--shiki-light:#032F62;--shiki-dark:#98C379\\">\\"Printing from Lib.so </span><span style=\\"--shiki-light:#005CC5;--shiki-dark:#D19A66\\">%d</span><span style=\\"--shiki-light:#005CC5;--shiki-dark:#56B6C2\\">\\\\n</span><span style=\\"--shiki-light:#032F62;--shiki-dark:#98C379\\">\\"</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\\">, i);</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\\">}</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\\">// Lib.h</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#D73A49;--shiki-dark:#C678DD\\">#ifndef</span><span style=\\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\\"> __LIB_H__</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#D73A49;--shiki-dark:#C678DD\\">#define</span><span style=\\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\\"> __LIB_H__</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#D73A49;--shiki-dark:#C678DD\\">void</span><span style=\\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\\"> foobar</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\\">(</span><span style=\\"--shiki-light:#D73A49;--shiki-dark:#C678DD\\">int</span><span style=\\"--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\\"> i</span><span style=\\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\\">);</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#D73A49;--shiki-dark:#C678DD\\">#endif</span></span></code></pre>\\n<div class=\\"line-numbers\\" aria-hidden=\\"true\\" style=\\"counter-reset:line-number 0\\"><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div></div></div>","autoDesc":true}')}}]);