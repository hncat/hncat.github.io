---
title: 第一章 编译和链接
date: 2024-06-22
tags:
    - 计算机基础
    - c/c++
categories: 链接、装载与库
isOriginal: true
order: 1
dir:
    order: 1
---
## 1. 被隐藏的过程
```c
// hello.c
#include <stdio.h>
int main() {
  printf("hello world\n");
  return 0;
}
```
使用gcc生成可执行文件
```bash
$> gcc hello.c -o hello
$> ./hello
Hello World
```
gcc生成可执行文件的四个步骤
1. 预处理
2. 编译
3. 汇编
4. 链接
### 1.1 预处理
```
1. 展开所有宏定义 (#define)
2. 处理所有预编译指令 (#if #ifdef #elif #else #endif)
3. 处理#include预编译指令,将被包含的文件插入到该预处理指令的位置。递归的执行
4. 删除所有注释
5. 添加行号和文件名标号。比如 #2 "hello.c" 2, 以便于编译时编译器产生调试用的行号信息及用于编译时产生编译错误或警告时能够显示行号。
6. 保留所有的#pragma编译指令，因为编译器需要使用它们。
```
生成预处理文件 *.i
```bash
$> gcc -E hello.c -o hello.i
或者
$> cpp hello.c > hello.i
```
### 1.2 编译
```
将预处理文件经过一系列词法分析、语法分析、语义分析及优化后生成汇编的过程。程序构建的核心。

生成汇编文件 .s
```
```bash
$> gcc -S hello.i -o hello.s
或者
$> /usr/lib/gcc/x86_64-linux-gnu/11/cc1 hello.i
```
### 1.3 汇编
```
将每一条汇编指令翻译成对应机器码的过程。

生成目标文件（或者中间目标文件）*.o
```
```bash
$> as hello.s -o hello.o
或者
$> gcc -c hello.s -o hello.o
```
### 1.4 链接 
```
通过使用链接器(ld)链接一堆文件生成最终的可执行文件的过程。

如hello文件
```
## 2. 静态链接
### 2.1 链接的基本定义
```
将每个源代码模块独立编译，然后安装需要将他们“组装”起来的过程被称为链接。
链接的本质就是把一些指令对其它符号地址的引用加以修改。
```
### 2.2 链接的过程
```
地址和空间分配、符号决议和重定位。
```
### 2.3 重定位
```
在链接过程中，对定义在其它目标文件中的函数调用的指令需要被重新调整，对使用定义在其它目标文件中的变量也是如此。

比如:
  有目标文件A有全局变量var
  对目标文件B有 movq 0x2a, var

  c7 05 00 00 00 00 2a    movq   $0x2a,0x0(%rip)

由于编译目标文件B时无法确认var的目标地址，所以编译器在无法确认var地址的情况下，只能将movq指令的目标地址置0，
等待链接器再将目标文件A和B链接起来时再将其修正。

例如A和B链接后，变量var的地址确认为0x1000，那么链接器将会把这个指令的目标地址部分修改为0x1000。
这个地址修正的过程也被叫做“重定位(Relocation)”，每个要修正的地方叫一个“重定位入口(Relocation Entry)”。
重定位所做的就是给程序中每个这样的绝对地址引用的地址进行修正。
```
### 2.4 其它
```
运行时库：支撑程序运行的基本函数集合。
库：一组目标文件(.o后缀的文件)的包
```